{"version":3,"file":"page.esm.js","sources":["../src/WindowSize.ts","../src/Page.ts","../src/Pages.ts","../src/index.ts"],"sourcesContent":["let width = 0;\nlet height = 0;\n\nfunction resize() {\n  width = window.innerWidth;\n  height = window.innerHeight;\n}\n\nwindow.addEventListener(\"resize\", resize);\n\nresize();\n\nexport {width, height};\n","import Component from \"@egjs/component\";\nimport {splitSpace, splitUnit, isArray, $, isObject, splitBracket, IObject} from \"@daybrush/utils\";\nimport * as WindowSize from \"./WindowSize\";\nimport Pages from \"./Pages\";\n\n/**\n * @memberof Page\n * @typedef\n */\nexport interface PageState {\n  enter: boolean;\n  firstEnter: boolean;\n  firstExit: boolean;\n}\n/**\n * @memberof Page\n * @typedef\n */\nexport interface PageOptions {\n  range?: Array<number | string>;\n  margin?: number | string |  Array<number | string>;\n  events?: string[];\n}\n/**\n * @memberof Page\n * @typedef\n */\nexport interface Rect {\n  top: number;\n  height: number;\n}\n/**\n * You can check the page in and out of the screen.\n * @extends eg.Component\n * @sort 1\n * @example\nconst page = new Page(\".page1\", {\n  range: [\"0%\", \"100%\"],\n  margin: [0, 0],\n  // Registers events automatically.\n  events: [\"resize\", \"scroll\"]\n});\n */\nclass Page extends Component {\n  public static s: typeof Pages;\n  private ranges: IObject<Page> = {};\n  private _range: Array<string | number> = [0, \"100%\"];\n  private margin: Array<string | number> = [0, 0];\n  private pages: Page[] = [];\n  private el: Element | null;\n  private state: PageState = {\n    enter: false,\n    firstEnter: false,\n    firstExit: false,\n  };\n  /**\n   */\n  constructor(el?: string | Element, options: PageOptions = {}) {\n    super();\n\n    this.el = el ? (isObject(el) ? el : $(el)) : null;\n    if (\"range\" in options) {\n      this._range = options.range!;\n    }\n    if (\"margin\" in options) {\n      const margin = options.margin!;\n\n      if (isArray(margin)) {\n        this.margin = margin;\n      } else {\n        this.margin = [margin, margin];\n      }\n    }\n    if (\"events\" in options) {\n      options.events!.forEach(name => {\n        if (name === \"resize\") {\n          window.addEventListener(\"resize\", this.resize);\n        } else if (name === \"scroll\") {\n          window.addEventListener(\"scroll\", this.scroll);\n        } else {\n          this.el && this.el.addEventListener(name, this.scroll);\n        }\n      });\n    }\n  }\n  /**\n   */\n  public add(page: Page) {\n    this.pages.push(page);\n\n    return this;\n  }\n  /**\n   */\n  public range(range: Array<string | number> | number | string = [0, \"100%\"]) {\n    const rangeArr = isArray(range) ? range : [range, range];\n    const id = `[${rangeArr.join(\",\")}]`;\n\n    if (this.ranges[id]) {\n      return this.ranges[id];\n    }\n    const page = new Page(this.el!, {\n      range: rangeArr,\n    });\n\n    this.ranges[id] = page;\n    this.add(page);\n    return page;\n  }\n  /**\n   * @method\n   */\n  public scroll = () => {\n    this.onCheck();\n  }\n  /**\n   * @method\n   */\n  public resize = () => {\n    this.onCheck();\n  }\n  public triggerEvent(name: string) {\n    this.trigger(name, {\n      target: this.el,\n    });\n  }\n  public onEnter(rect: Rect) {\n    const state = this.state;\n\n    if (!state.enter) {\n      state.enter = true;\n\n      if (!state.firstEnter) {\n        state.firstEnter = true;\n\n        /**\n         * An event that occurs when you first enter a page.\n         * @event Page#firstEnter\n         */\n        this.triggerEvent(\"firstEnter\");\n      }\n      /**\n       * An event that occurs when you enter a page.\n       * @event Page#enter\n       */\n      this.triggerEvent(\"enter\");\n    }\n    this.pages.forEach(page => {\n      page.onCheck(page.el === this.el ? rect : undefined);\n    });\n  }\n  public onExit() {\n    const state = this.state;\n\n    if (state.enter) {\n      state.enter = false;\n\n      if (!state.firstExit) {\n        state.firstExit = true;\n        /**\n         * An event that occurs when you first exit a page.\n         * @event Page#firstExit\n         */\n        this.triggerEvent(\"firstExit\");\n      }\n      /**\n       * An event that occurs when you exit a page.\n       * @event Page#exit\n       */\n      this.triggerEvent(\"exit\");\n    }\n    this.pages.forEach(page => {\n      page.onExit();\n    });\n  }\n  public calcSize(size: string | number, rect: Rect) {\n    if (typeof size === \"number\") {\n      return size;\n    }\n    const sizeInfos: Array<string | number> = splitSpace(size);\n\n    if (!sizeInfos) {\n      return 0;\n    }\n    const length = sizeInfos.length;\n    const stack: number[] = [];\n    let sign = 1;\n\n    for (let i = 0; i < length; ++i) {\n      const v = sizeInfos[i];\n\n      if (v === \"+\") {\n        sign = 1;\n      } else if (v === \"-\") {\n        sign = -1;\n      } else if (v === \"*\") {\n        stack.push((stack.pop()! || 0) * this._calcSize(sizeInfos[i + 1], rect));\n        ++i;\n      } else if (v === \"/\") {\n        stack.push((stack.pop()! || 0) / this._calcSize(sizeInfos[i + 1], rect));\n        ++i;\n      } else {\n        stack.push(sign * this._calcSize(v, rect));\n        sign = 1;\n      }\n    }\n    return stack.reduce((prev, cur) => {\n      return prev + cur;\n    }, 0);\n  }\n  public onCheck(rect: Rect | undefined = this.el ? this.el.getBoundingClientRect() : undefined) {\n    if (rect) {\n      const top = rect.top;\n      const height = rect.height;\n      const obj = {top, height};\n\n      const rangeStart = this.calcSize(this._range[0], obj);\n      const rangeEnd = this.calcSize(this._range[1], obj);\n      const marginTop = this.calcSize(this.margin[0], obj);\n      const marginBottom = this.calcSize(this.margin[1], obj);\n\n      if (top + rangeEnd + marginBottom <= 0 || top + rangeStart - marginTop >= WindowSize.height) {\n        this.onExit();\n      } else {\n        this.onEnter(rect);\n      }\n    } else {\n      this.pages.forEach(page => {\n        page.onCheck();\n      });\n    }\n  }\n  private _calcSize(size: string | number, rect: Rect) {\n    if (!size) {\n      return 0;\n    }\n    if (typeof size === \"number\") {\n      return size;\n    }\n    if (size === \"window\") {\n      return WindowSize.height;\n    }\n    if (size.indexOf(\"(\") > -1) {\n      return this.calcSize(splitBracket(size).value!, rect);\n    }\n    const info = splitUnit(size);\n\n    if (info.unit === \"%\") {\n      return rect.height * info.value / 100;\n    } else {\n      return info.value;\n    }\n  }\n}\n\nexport default Page;\n","import Page, { PageOptions } from \"./Page\";\n\n/**\n * @sort 2\n * @example\nimport Page from \"@daybrush/page\";\n\nconst pages = new Page.s({\n  events: [\"scroll\", \"resize\"];\n});\n\npages.add(new Page(\".page1\"));\n\npages.scroll();\n */\nclass Pages extends Page {\n  /**\n   */\n  constructor(options: PageOptions = {}) {\n    super(undefined, options);\n  }\n}\n\nexport default Pages;\n","import Page from \"./Page\";\nimport Pages from \"./Pages\";\n\nPage.s = Pages;\n\nexport default Page;\n"],"names":["width","height","resize","window","innerWidth","innerHeight","addEventListener","tslib_1","el","options","_super","_this","enter","firstEnter","firstExit","onCheck","isObject","$","_range","range","margin","isArray","events","forEach","name","scroll","page","pages","push","rangeArr","id","join","ranges","Page","add","trigger","target","rect","state","triggerEvent","undefined","onExit","size","sizeInfos","splitSpace","length","stack","sign","i","v","pop","_calcSize","reduce","prev","cur","getBoundingClientRect","top","obj","rangeStart","calcSize","rangeEnd","marginTop","marginBottom","WindowSize","onEnter","indexOf","splitBracket","value","info","splitUnit","unit","Component","s","Pages"],"mappings":"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"}