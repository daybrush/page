{"version":3,"file":"page.main.js","sources":["../src/WindowSize.ts","../src/Page.ts","../src/Pages.ts","../src/index.ts"],"sourcesContent":["let width = 0;\nlet height = 0;\n\nfunction resize() {\n  width = window.innerWidth;\n  height = window.innerHeight;\n}\n\nwindow.addEventListener(\"resize\", resize);\n\nresize();\n\nexport {width, height};\n","import Component from \"@egjs/component\";\nimport {splitSpace, splitUnit, isArray, $, isObject, splitBracket, IObject} from \"@daybrush/utils\";\nimport * as WindowSize from \"./WindowSize\";\nimport Pages from \"./Pages\";\n\n/**\n * @memberof Page\n * @typedef\n */\nexport interface PageState {\n  enter: boolean;\n  firstEnter: boolean;\n  firstExit: boolean;\n}\n/**\n * @memberof Page\n * @typedef\n */\nexport interface PageOptions {\n  range?: Array<number | string>;\n  margin?: number | string |  Array<number | string>;\n  events?: string[];\n}\n/**\n * @memberof Page\n * @typedef\n */\nexport interface Rect {\n  top: number;\n  height: number;\n}\n/**\n * You can check the page in and out of the screen.\n * @extends eg.Component\n * @sort 1\n * @example\nconst page = new Page(\".page1\", {\n  range: [\"0%\", \"100%\"],\n  margin: [0, 0],\n  // Registers events automatically.\n  events: [\"resize\", \"scroll\"]\n});\n */\nclass Page extends Component {\n  public static s: typeof Pages;\n  private ranges: IObject<Page> = {};\n  private _range: Array<string | number> = [0, \"100%\"];\n  private margin: Array<string | number> = [0, 0];\n  private pages: Page[] = [];\n  private el: Element | null;\n  private state: PageState = {\n    enter: false,\n    firstEnter: false,\n    firstExit: false,\n  };\n  /**\n   */\n  constructor(el?: string | Element, options: PageOptions = {}) {\n    super();\n\n    this.el = el ? (isObject(el) ? el : $(el)) : null;\n    if (\"range\" in options) {\n      this._range = options.range!;\n    }\n    if (\"margin\" in options) {\n      const margin = options.margin!;\n\n      if (isArray(margin)) {\n        this.margin = margin;\n      } else {\n        this.margin = [margin, margin];\n      }\n    }\n    if (\"events\" in options) {\n      options.events!.forEach(name => {\n        if (name === \"resize\") {\n          window.addEventListener(\"resize\", this.resize);\n        } else if (name === \"scroll\") {\n          window.addEventListener(\"scroll\", this.scroll);\n        } else {\n          this.el && this.el.addEventListener(name, this.scroll);\n        }\n      });\n    }\n  }\n  /**\n   */\n  public add(page: Page) {\n    this.pages.push(page);\n\n    return this;\n  }\n  /**\n   */\n  public range(range: Array<string | number> | number | string = [0, \"100%\"]) {\n    const rangeArr = isArray(range) ? range : [range, range];\n    const id = `[${rangeArr.join(\",\")}]`;\n\n    if (this.ranges[id]) {\n      return this.ranges[id];\n    }\n    const page = new Page(this.el!, {\n      range: rangeArr,\n    });\n\n    this.ranges[id] = page;\n    this.add(page);\n    return page;\n  }\n  /**\n   * @method\n   */\n  public scroll = () => {\n    this.onCheck();\n  }\n  /**\n   * @method\n   */\n  public resize = () => {\n    this.onCheck();\n  }\n  public triggerEvent(name: string) {\n    this.trigger(name, {\n      target: this.el,\n    });\n  }\n  public onEnter(rect: Rect) {\n    const state = this.state;\n\n    if (!state.enter) {\n      state.enter = true;\n\n      if (!state.firstEnter) {\n        state.firstEnter = true;\n\n        /**\n         * An event that occurs when you first enter a page.\n         * @event Page#firstEnter\n         */\n        this.triggerEvent(\"firstEnter\");\n      }\n      /**\n       * An event that occurs when you enter a page.\n       * @event Page#enter\n       */\n      this.triggerEvent(\"enter\");\n    }\n    this.pages.forEach(page => {\n      page.onCheck(page.el === this.el ? rect : undefined);\n    });\n  }\n  public onExit() {\n    const state = this.state;\n\n    if (state.enter) {\n      state.enter = false;\n\n      if (!state.firstExit) {\n        state.firstExit = true;\n        /**\n         * An event that occurs when you first exit a page.\n         * @event Page#firstExit\n         */\n        this.triggerEvent(\"firstExit\");\n      }\n      /**\n       * An event that occurs when you exit a page.\n       * @event Page#exit\n       */\n      this.triggerEvent(\"exit\");\n    }\n    this.pages.forEach(page => {\n      page.onExit();\n    });\n  }\n  public calcSize(size: string | number, rect: Rect) {\n    if (typeof size === \"number\") {\n      return size;\n    }\n    const sizeInfos: Array<string | number> = splitSpace(size);\n\n    if (!sizeInfos) {\n      return 0;\n    }\n    const length = sizeInfos.length;\n    const stack: number[] = [];\n    let sign = 1;\n\n    for (let i = 0; i < length; ++i) {\n      const v = sizeInfos[i];\n\n      if (v === \"+\") {\n        sign = 1;\n      } else if (v === \"-\") {\n        sign = -1;\n      } else if (v === \"*\") {\n        stack.push((stack.pop()! || 0) * this._calcSize(sizeInfos[i + 1], rect));\n        ++i;\n      } else if (v === \"/\") {\n        stack.push((stack.pop()! || 0) / this._calcSize(sizeInfos[i + 1], rect));\n        ++i;\n      } else {\n        stack.push(sign * this._calcSize(v, rect));\n        sign = 1;\n      }\n    }\n    return stack.reduce((prev, cur) => {\n      return prev + cur;\n    }, 0);\n  }\n  public onCheck(rect: Rect | undefined = this.el ? this.el.getBoundingClientRect() : undefined) {\n    if (rect) {\n      const top = rect.top;\n      const height = rect.height;\n      const obj = {top, height};\n\n      const rangeStart = this.calcSize(this._range[0], obj);\n      const rangeEnd = this.calcSize(this._range[1], obj);\n      const marginTop = this.calcSize(this.margin[0], obj);\n      const marginBottom = this.calcSize(this.margin[1], obj);\n\n      if (top + rangeEnd + marginBottom <= 0 || top + rangeStart - marginTop >= WindowSize.height) {\n        this.onExit();\n      } else {\n        this.onEnter(rect);\n      }\n    } else {\n      this.pages.forEach(page => {\n        page.onCheck();\n      });\n    }\n  }\n  private _calcSize(size: string | number, rect: Rect) {\n    if (!size) {\n      return 0;\n    }\n    if (typeof size === \"number\") {\n      return size;\n    }\n    if (size === \"window\") {\n      return WindowSize.height;\n    }\n    if (size.indexOf(\"(\") > -1) {\n      return this.calcSize(splitBracket(size).value!, rect);\n    }\n    const info = splitUnit(size);\n\n    if (info.unit === \"%\") {\n      return rect.height * info.value / 100;\n    } else {\n      return info.value;\n    }\n  }\n}\n\nexport default Page;\n","import Page, { PageOptions } from \"./Page\";\n\n/**\n * @sort 2\n * @example\nimport Page from \"@daybrush/page\";\n\nconst pages = new Page.s({\n  events: [\"scroll\", \"resize\"];\n});\n\npages.add(new Page(\".page1\"));\n\npages.scroll();\n */\nclass Pages extends Page {\n  /**\n   */\n  constructor(options: PageOptions = {}) {\n    super(undefined, options);\n  }\n}\n\nexport default Pages;\n","import Page from \"./Page\";\nimport Pages from \"./Pages\";\n\nPage.s = Pages;\n\nexport default Page;\n"],"names":["width","height","resize","window","innerWidth","innerHeight","addEventListener","tslib_1","el","options","_super","_this","enter","firstEnter","firstExit","onCheck","isObject","$","_range","range","margin","isArray","events","forEach","name","scroll","page","pages","push","rangeArr","id","join","ranges","Page","add","trigger","target","rect","state","triggerEvent","undefined","onExit","size","sizeInfos","splitSpace","length","stack","sign","i","v","pop","_calcSize","reduce","prev","cur","getBoundingClientRect","top","obj","rangeStart","calcSize","rangeEnd","marginTop","marginBottom","WindowSize","onEnter","indexOf","splitBracket","value","info","splitUnit","unit","Component","s","Pages"],"mappings":"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"}